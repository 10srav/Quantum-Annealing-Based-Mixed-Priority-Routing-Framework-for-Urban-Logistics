---
phase: 04-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_security.py
autonomous: true

must_haves:
  truths:
    - "Path traversal attempts (../) are rejected with 400"
    - "Error messages do not expose internal file paths"
    - "Error messages do not expose stack traces"
    - "Invalid graph names are rejected safely"
  artifacts:
    - path: "backend/tests/test_security.py"
      provides: "Security test suite"
      min_lines: 80
  key_links:
    - from: "backend/tests/test_security.py"
      to: "backend/src/security.py"
      via: "validate_graph_path import"
      pattern: "from src.security import"
---

<objective>
Create security-focused test suite for TEST-02

Purpose: Verify that the API correctly prevents path traversal attacks and does not leak internal paths, stack traces, or sensitive information in error responses.

Output: `backend/tests/test_security.py` with comprehensive security test coverage
</objective>

<execution_context>
@C:\Users\polli\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\polli\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@backend/app/main.py
@backend/src/security.py
@backend/tests/test_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create path traversal and injection test suite</name>
  <files>backend/tests/test_security.py</files>
  <action>
Create `backend/tests/test_security.py` with security-focused tests:

**Class: TestPathTraversal**
- `test_simple_traversal` - Request `/graphs/../../../etc/passwd`, expect 400 (not 200/404 with file contents)
- `test_double_encoded_traversal` - Request `/graphs/%2e%2e%2f%2e%2e%2fetc%2fpasswd`, expect 400
- `test_windows_traversal` - Request `/graphs/..\\..\\windows\\system32`, expect 400
- `test_null_byte_injection` - Request `/graphs/valid%00.json`, expect 400
- `test_url_encoded_dots` - Request `/graphs/%2e%2e/secret`, expect 400
- `test_mixed_slashes` - Request `/graphs/..//../../etc`, expect 400

**Class: TestGraphNameValidation**
- `test_valid_alphanumeric` - Request `/graphs/city01`, should work (200 or 404 if not exists)
- `test_valid_with_hyphen` - Request `/graphs/city-test`, should work
- `test_valid_with_underscore` - Request `/graphs/city_test`, should work
- `test_invalid_with_dots` - Request `/graphs/city.test`, expect 400
- `test_invalid_with_space` - Request `/graphs/city test`, expect 400
- `test_invalid_with_slash` - Request `/graphs/city/test`, expect 400 or 404 (not security issue)
- `test_empty_name` - Request `/graphs/`, behavior depends on routing

**Class: TestErrorMessageSanitization**
- `test_traversal_error_no_path_leak` - Verify path traversal error doesn't contain actual system paths
- `test_not_found_error_no_path_leak` - Verify 404 error doesn't expose DATA_DIR path
- `test_internal_error_no_stack_trace` - Force an internal error, verify no stack trace in response

Add helper for path leak detection:
```python
SENSITIVE_PATTERNS = [
    r'/home/',
    r'/Users/',
    r'C:\\',
    r'/var/',
    r'/etc/',
    r'backend/',
    r'\.py',
    r'Traceback',
    r'File "',
    r'line \d+',
]

def assert_no_sensitive_info(response_text: str):
    """Assert response doesn't contain sensitive path or stack info."""
    import re
    for pattern in SENSITIVE_PATTERNS:
        assert not re.search(pattern, response_text, re.IGNORECASE), \
            f"Response contains sensitive pattern '{pattern}': {response_text[:200]}"
```
  </action>
  <verify>
Run: `cd backend && python -m pytest tests/test_security.py -v`
All tests should pass.
  </verify>
  <done>
- Path traversal tests cover Unix and Windows patterns
- Graph name validation tests cover allowlist boundaries
- Error sanitization tests verify no path/stack leaks
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for security module</name>
  <files>backend/tests/test_security.py</files>
  <action>
Add unit tests for the security module functions directly:

**Class: TestValidateGraphPathUnit**
```python
import pytest
from src.security import validate_graph_path, DATA_DIR, GRAPH_NAME_PATTERN

class TestValidateGraphPathUnit:
    """Unit tests for validate_graph_path function."""

    def test_valid_name_returns_path(self):
        """Valid name should return a Path object."""
        result = validate_graph_path("test-graph")
        assert result.name == "test-graph.json"
        assert result.parent == DATA_DIR.resolve()

    def test_traversal_raises_valueerror(self):
        """Path traversal should raise ValueError."""
        with pytest.raises(ValueError) as exc:
            validate_graph_path("../secret")
        assert "Invalid graph name" in str(exc.value)

    def test_dots_rejected(self):
        """Names with dots should be rejected."""
        with pytest.raises(ValueError):
            validate_graph_path("file.json")

    def test_spaces_rejected(self):
        """Names with spaces should be rejected."""
        with pytest.raises(ValueError):
            validate_graph_path("my graph")

    def test_special_chars_rejected(self):
        """Names with special characters should be rejected."""
        for char in ['!', '@', '#', '$', '%', '^', '&', '*', '(', ')']:
            with pytest.raises(ValueError):
                validate_graph_path(f"graph{char}name")
```

**Class: TestGraphNamePattern**
```python
class TestGraphNamePattern:
    """Tests for the GRAPH_NAME_PATTERN regex."""

    @pytest.mark.parametrize("name", [
        "valid",
        "valid123",
        "valid-name",
        "valid_name",
        "UPPERCASE",
        "MixedCase123",
        "a",
        "a1",
    ])
    def test_valid_patterns(self, name):
        """Valid names should match the pattern."""
        assert GRAPH_NAME_PATTERN.match(name)

    @pytest.mark.parametrize("name", [
        "../traversal",
        "with space",
        "with.dot",
        "with/slash",
        "with\\backslash",
        "",
        "with:colon",
        "with?question",
    ])
    def test_invalid_patterns(self, name):
        """Invalid names should not match the pattern."""
        assert not GRAPH_NAME_PATTERN.match(name)
```
  </action>
  <verify>
Run: `cd backend && python -m pytest tests/test_security.py -v --tb=short`
All tests pass including unit tests for security module.
  </verify>
  <done>
- Unit tests for validate_graph_path exist
- Parametrized tests for GRAPH_NAME_PATTERN exist
- All security validation paths are tested
- ValueError messages are verified
  </done>
</task>

</tasks>

<verification>
Run the complete test suite to ensure no regressions:
```bash
cd backend && python -m pytest tests/ -v
```

Verify specific coverage of TEST-02 requirements:
- Path traversal: At least 6 test cases
- Error sanitization: At least 3 test cases verifying no leaks
</verification>

<success_criteria>
1. `backend/tests/test_security.py` exists with 25+ test cases
2. All tests pass when run with pytest
3. Tests cover all TEST-02 success criteria:
   - Path traversal attempts return 400
   - Error messages contain no internal paths
   - Error messages contain no stack traces
4. Security module has unit test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing/04-02-SUMMARY.md`
</output>
