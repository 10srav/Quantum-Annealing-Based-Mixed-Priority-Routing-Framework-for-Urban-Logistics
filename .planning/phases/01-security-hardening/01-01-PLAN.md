---
phase: 01-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/security.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Graph endpoint rejects path traversal attempts with 400 status"
    - "Graph names containing ../ or special characters return validation error"
    - "Resolved file paths stay within backend/data directory"
  artifacts:
    - path: "backend/src/security.py"
      provides: "Path validation utilities with allowlist pattern"
      exports: ["validate_graph_path", "GRAPH_NAME_PATTERN"]
    - path: "backend/app/main.py"
      provides: "Secured graph endpoint using path validation"
      contains: "validate_graph_path"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/src/security.py"
      via: "import validate_graph_path"
      pattern: "from src.security import"
---

<objective>
Fix path traversal vulnerability in the `/graphs/{graph_name}` endpoint by implementing allowlist-based path validation.

Purpose: Prevent attackers from accessing arbitrary files on the server by injecting `../` sequences or special characters in graph names.
Output: New `security.py` module with path validation, and updated `main.py` that uses it.
</objective>

<execution_context>
@C:\Users\polli\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\polli\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-security-hardening/01-RESEARCH.md

Key references:
@backend/app/main.py (lines 145-159 - current vulnerable implementation)
@backend/src/config.py (settings pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security.py with path validation utilities</name>
  <files>backend/src/security.py</files>
  <action>
Create new file `backend/src/security.py` with:

1. Import `pathlib.Path`, `re`, and define module-level constants
2. Define `GRAPH_NAME_PATTERN = re.compile(r'^[a-zA-Z0-9_-]+$')` - alphanumeric, hyphen, underscore only
3. Define `DATA_DIR = Path(__file__).parent.parent / "data"` - resolves to backend/data
4. Create `validate_graph_path(graph_name: str) -> Path` function that:
   - Raises `ValueError` with message "Invalid graph name: must be alphanumeric, hyphens, underscores only" if pattern doesn't match
   - Constructs filepath as `(DATA_DIR / f"{graph_name}.json").resolve()`
   - Raises `ValueError` with message "Invalid graph path: path traversal detected" if `not filepath.is_relative_to(DATA_DIR.resolve())`
   - Returns the validated absolute Path

Include docstrings explaining the security purpose of each check.
  </action>
  <verify>
Run: `python -c "from backend.src.security import validate_graph_path, GRAPH_NAME_PATTERN; print('Import OK')"`
  </verify>
  <done>security.py exists with validate_graph_path function that raises ValueError for invalid inputs</done>
</task>

<task type="auto">
  <name>Task 2: Update graph endpoint to use path validation</name>
  <files>backend/app/main.py</files>
  <action>
Modify `backend/app/main.py`:

1. Add import: `from src.security import validate_graph_path`
2. Replace the `get_graph` endpoint (lines 145-159) with secured version:
   - Wrap call to `validate_graph_path(graph_name)` in try/except ValueError
   - On ValueError, raise `HTTPException(status_code=400, detail=str(e))`
   - Check `if not filepath.exists()` and raise 404
   - Load and return JSON as before

3. Also update `list_graphs` endpoint to use `DATA_DIR` from security module for consistency:
   - Add `from src.security import DATA_DIR` to import
   - Replace `os.path.join(os.path.dirname(__file__), "..", "data")` with `DATA_DIR`

Remove the old `os.path` based path construction entirely.
  </action>
  <verify>
Run tests:
```bash
cd backend && python -c "
import asyncio
from app.main import get_graph
# Test valid graph name
try:
    asyncio.run(get_graph('sample-city'))
    print('Valid name: OK (or 404 if no file)')
except Exception as e:
    print(f'Valid name result: {e}')

# Test path traversal attempt
try:
    asyncio.run(get_graph('../../../etc/passwd'))
    print('FAIL: traversal not blocked')
except Exception as e:
    print(f'Traversal blocked: {e}')
"
```
  </verify>
  <done>get_graph endpoint returns 400 for invalid names and path traversal attempts</done>
</task>

</tasks>

<verification>
Manual verification:
1. Start the API: `cd backend && uvicorn app.main:app --reload`
2. Test valid request: `curl http://localhost:8000/graphs/sample-city` (should return graph or 404)
3. Test path traversal: `curl http://localhost:8000/graphs/../../../etc/passwd` (should return 400)
4. Test special chars: `curl http://localhost:8000/graphs/test.json` (should return 400 - dot not allowed)
5. Test valid chars: `curl http://localhost:8000/graphs/my-graph_01` (should work if file exists)
</verification>

<success_criteria>
- Path traversal attempts (`../`) return 400 status with validation error message
- Special characters (`.`, `/`, `\`, spaces) in graph names return 400
- Valid graph names (alphanumeric, hyphen, underscore) work normally
- No file paths, stack traces, or internal details exposed in error responses
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-01-SUMMARY.md`
</output>
