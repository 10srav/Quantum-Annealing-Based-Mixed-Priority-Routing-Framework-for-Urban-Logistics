---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/auth.py
  - backend/src/config.py
  - backend/app/main.py
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "Requests without X-API-Key header receive 401 Unauthorized"
    - "Requests with invalid API key receive 401 Unauthorized"
    - "Requests with valid API key proceed to endpoint"
    - "API keys are stored as hashes, never plaintext"
    - "Health endpoint remains accessible without authentication"
  artifacts:
    - path: "backend/src/auth.py"
      provides: "API key validation and middleware"
      exports: ["verify_api_key", "hash_api_key"]
    - path: "backend/src/config.py"
      provides: "API key hash configuration"
      contains: "api_key_hash"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/src/auth.py"
      via: "Depends(verify_api_key)"
      pattern: "Depends.*verify_api_key"
---

<objective>
Implement API key authentication middleware for the Quantum Priority Router API.

Purpose: Protect API endpoints from unauthorized access using header-based API key validation with secure hash comparison.

Output: Working authentication that rejects unauthenticated requests with 401, validates keys via hash comparison, and exempts health check endpoint.
</objective>

<execution_context>
@C:\Users\polli\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\polli\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/main.py
@backend/src/config.py
@backend/src/security.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key authentication module</name>
  <files>backend/src/auth.py, backend/src/config.py, backend/.env.example</files>
  <action>
Create `backend/src/auth.py` with:

1. `hash_api_key(key: str) -> str` function:
   - Use hashlib.sha256 to hash the key
   - Return hex digest
   - This is for generating hashes to store in config (one-way)

2. `verify_api_key(x_api_key: str = Header(...))` FastAPI dependency:
   - Extract X-API-Key header (required)
   - Hash the provided key
   - Compare against stored hash from settings using secrets.compare_digest (timing-safe)
   - Raise HTTPException(status_code=401, detail="Invalid API key") if mismatch
   - Return True if valid

Update `backend/src/config.py`:
- Add `api_key_hash: str = ""` to Settings class
- This stores the SHA-256 hash of the valid API key (NOT the key itself)

Create/update `backend/.env.example`:
- Add `API_KEY_HASH=` with comment explaining to generate via `python -c "import hashlib; print(hashlib.sha256(b'your-api-key').hexdigest())"`

IMPORTANT: Never store or log plaintext API keys. Only the hash is stored in configuration.
  </action>
  <verify>
- File exists: `backend/src/auth.py`
- `verify_api_key` function exists and uses `secrets.compare_digest`
- `hash_api_key` function exists and uses `hashlib.sha256`
- Settings class has `api_key_hash` field
  </verify>
  <done>
Auth module created with hash-based key verification using timing-safe comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply authentication middleware to endpoints</name>
  <files>backend/app/main.py</files>
  <action>
Modify `backend/app/main.py`:

1. Import the auth dependency:
   ```python
   from src.auth import verify_api_key
   ```

2. Add `Depends(verify_api_key)` to protected endpoints:
   - `/solve` - POST
   - `/compare` - POST
   - `/generate-city` - POST
   - `/graphs` - GET
   - `/graphs/{graph_name}` - GET

3. Keep `/health` endpoint UNPROTECTED (no dependency):
   - Health checks must work without auth for monitoring systems

Example endpoint modification:
```python
@app.post("/solve", response_model=SolverResponse)
async def solve_route(request: SolverRequest, _: bool = Depends(verify_api_key)):
```

The `_: bool` discards the return value while still requiring the dependency check.
  </action>
  <verify>
Run test with no API key:
```bash
cd backend && curl -X POST http://localhost:8000/solve -H "Content-Type: application/json" -d '{"graph":{"nodes":[],"edges":[]},"solver":"greedy"}' -w "\n%{http_code}\n"
```
Should return 401 (or 422 if header required message).

Run health check (should work without key):
```bash
curl http://localhost:8000/health -w "\n%{http_code}\n"
```
Should return 200.
  </verify>
  <done>
All data endpoints require valid API key. Health endpoint accessible without authentication.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test API key and verify end-to-end</name>
  <files>backend/.env</files>
  <action>
1. Generate a test API key hash:
   ```python
   import hashlib
   test_key = "test-api-key-for-dev"
   hash_value = hashlib.sha256(test_key.encode()).hexdigest()
   print(hash_value)
   ```

2. Create/update `backend/.env` with the hash:
   ```
   API_KEY_HASH=<generated-hash>
   ```

3. Test the full flow:
   - Request without key -> 401
   - Request with wrong key -> 401
   - Request with correct key -> endpoint responds normally

Note: The .env file should be in .gitignore. Only .env.example is committed.
  </action>
  <verify>
Start server and test:
```bash
cd backend
# Start server in background or separate terminal
# Test with valid key
curl -X GET http://localhost:8000/graphs -H "X-API-Key: test-api-key-for-dev" -w "\n%{http_code}\n"
# Should return 200 with graphs list

# Test with invalid key
curl -X GET http://localhost:8000/graphs -H "X-API-Key: wrong-key" -w "\n%{http_code}\n"
# Should return 401

# Test without key
curl -X GET http://localhost:8000/graphs -w "\n%{http_code}\n"
# Should return 401 or 422
```
  </verify>
  <done>
API key authentication working end-to-end. Valid key allows access, invalid/missing key returns 401.
  </done>
</task>

</tasks>

<verification>
1. Unauthenticated request to /solve returns 401
2. Unauthenticated request to /health returns 200 (exempt)
3. Request with invalid X-API-Key header returns 401
4. Request with valid X-API-Key header returns normal response
5. No plaintext API keys in config files or logs
</verification>

<success_criteria>
- AUTH-01 satisfied: Requests without valid API key receive 401
- AUTH-02 satisfied: API keys stored as hashes only
- All protected endpoints require authentication
- Health endpoint remains public for monitoring
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
